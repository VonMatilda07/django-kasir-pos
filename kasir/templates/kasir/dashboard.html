<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Dashboard Analisis</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h1>Dashboard Analisis</h1>
            <a href="{% url 'cashier_page' %}" class="btn btn-secondary">Kembali ke Kasir</a>
        </div>
        <hr>

        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card text-white bg-primary">
                    <div class="card-body">
                        <h5 class="card-title">Omzet Hari Ini</h5>
                        <p class="card-text fs-4">Rp {{ total_sales_today|floatformat:0 }}</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card text-white bg-success">
                    <div class="card-body">
                        <h5 class="card-title">Jumlah Transaksi</h5>
                        <p class="card-text fs-4">{{ total_transactions_today }}</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card text-white bg-warning">
                    <div class="card-body">
                        <h5 class="card-title">Rata-rata per Transaksi</h5>
                        <p class="card-text fs-4">Rp {{ average_per_transaction|floatformat:0 }}</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Penjualan per Jam (Hari Ini)</h5>
                        <canvas id="salesPerHourChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Produk Terlaris (30 Hari Terakhir)</h5>
                    </div>
                    <ul class="list-group list-group-flush" id="top-products-list">
                        </ul>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Produk Kurang Laku (30 Hari Terakhir)</h5>
                    </div>
                    <ul class="list-group list-group-flush" id="bottom-products-list">
                        </ul>
                </div>
            </div>
        </div>
        </div>

    <script>
        // Fungsi untuk grafik (tidak berubah)
        async function renderSalesChart() {
            try {
                const response = await fetch("{% url 'sales_per_hour_api' %}");
                const chartData = await response.json();
                const ctx = document.getElementById('salesPerHourChart').getContext('2d');
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: chartData.labels,
                        datasets: [{
                            label: 'Total Omzet (Rp)',
                            data: chartData.data,
                            backgroundColor: 'rgba(54, 162, 235, 0.6)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: { scales: { y: { beginAtZero: true } } }
                });
            } catch (error) {
                console.error('Gagal memuat data grafik:', error);
            }
        }

        // --- FUNGSI BARU UNTUK STATISTIK PRODUK ---
        async function loadProductStats() {
            try {
                const response = await fetch("{% url 'top_products_api' %}");
                const productData = await response.json();

                const topList = document.getElementById('top-products-list');
                const bottomList = document.getElementById('bottom-products-list');

                topList.innerHTML = '';
                bottomList.innerHTML = '';

                // Isi list produk terlaris
                productData.top_products.forEach(product => {
                    const li = document.createElement('li');
                    li.className = 'list-group-item d-flex justify-content-between align-items-center';
                    li.innerHTML = `${product.product__name} <span class="badge bg-success rounded-pill">${product.total_sold} terjual</span>`;
                    topList.appendChild(li);
                });

                // Isi list produk kurang laku
                productData.bottom_products.forEach(product => {
                    const li = document.createElement('li');
                    li.className = 'list-group-item d-flex justify-content-between align-items-center';
                    li.innerHTML = `${product.product__name} <span class="badge bg-danger rounded-pill">${product.total_sold} terjual</span>`;
                    bottomList.appendChild(li);
                });

            } catch (error) {
                console.error('Gagal memuat statistik produk:', error);
            }
        }

        // --- GANTI EVENT LISTENER LAMA DENGAN YANG INI ---
        // Panggil kedua fungsi saat halaman selesai dimuat
        document.addEventListener('DOMContentLoaded', () => {
            renderSalesChart();
            loadProductStats();
        });
    </script>
</body>
</html>